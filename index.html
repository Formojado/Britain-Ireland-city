<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK & Ireland City Speedrun</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Segoe UI, Poppins, Arial, sans-serif;background:#0f1724;color:#e6eef8}
    #map{height:100vh;width:100vw;position:relative;}

    .overlay-start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:1000;pointer-events:auto;}
    .start-box{background:#fff;color:#04263b;padding:24px 36px;border-radius:12px;text-align:center;box-shadow:0 4px 30px rgba(0,0,0,0.5)}
    .start-box h2{margin-top:0;margin-bottom:8px}
    .btn{background:#60a5fa;color:#04263b;border:none;padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;}

    .info-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);padding:8px 14px;border-radius:8px;display:flex;gap:16px;z-index:900;color:#fff;font-size:0.95rem;}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;}
    .modal{background:#fff;color:#04263b;padding:22px;border-radius:12px;min-width:320px;text-align:center;}
    .modal h3{margin:0 0 8px}
    .city-title{position:absolute;top:50px;left:50%;transform:translateX(-50%);z-index:1001;font-size:1.4rem;font-weight:700;color:#fff;text-shadow:1px 1px 4px #000;}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-bar">
    <div>‚è±Ô∏è Time: <span id="time">00:00</span></div>
    <div>üìç Progress: <span id="progress">0</span> / <span id="total">50</span></div>
    <div>‚≠ê Score: <span id="score">0</span></div>
  </div>

  <div id="overlayStart" class="overlay-start">
    <div class="start-box">
      <h2>UK & Ireland City Speedrun</h2>
      <p>Find 50 cities ‚Äî within 10 km counts as success</p>
      <button id="startBtn" class="btn">Start</button>
    </div>
  </div>

  <div class="city-title" id="cityTitle" style="display:none"></div>

  <div id="endModal" style="display:none" class="modal-backdrop">
    <div class="modal">
      <h3>üéâ Run Complete</h3>
      <div id="stats"></div>
      <div style="margin-top:14px"><button id="playAgainBtn" class="btn">Play Again</button></div>
    </div>
  </div>

  <script>
    const ALL_CITIES = [ /* ... same as before ... */ ];
    const TOTAL = 50;
    let cities=[],index=0,started=false,answered=false,markers=[],circles=[],score=0,startTime=null,timerInterval=null,results=[],currentCityMarker=null;

    const map = L.map('map',{zoomControl:true,dragging:true}).setView([54.5,-4],6);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);

    const timeEl=document.getElementById('time');
    const progressEl=document.getElementById('progress');
    const totalEl=document.getElementById('total');
    const scoreEl=document.getElementById('score');
    const overlayStart=document.getElementById('overlayStart');
    const startBtn=document.getElementById('startBtn');
    const endModal=document.getElementById('endModal');
    const statsEl=document.getElementById('stats');
    const playAgainBtn=document.getElementById('playAgainBtn');
    const cityTitle=document.getElementById('cityTitle');

    totalEl.textContent=TOTAL;

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    function toRad(v){return v*Math.PI/180}
    function haversine(a,b){const R=6371;const dLat=toRad(b[0]-a[0]);const dLon=toRad(b[1]-a[1]);const lat1=toRad(a[0]);const lat2=toRad(b[0]);const aa=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa))}
    function formatTime(ms){const s=Math.floor(ms/1000);const mm=Math.floor(s/60);const ss=s%60;return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`}

    function resetGame(){
      cities=shuffle(ALL_CITIES.slice()).slice(0,TOTAL);
      index=0;
      started=false;
      answered=false;
      score=0;
      results=[];
      clearMapObjects(true);
      cityTitle.style.display='none';
      updateUI();
      timeEl.textContent='00:00';
      scoreEl.textContent=score;
      progressEl.textContent='0';
      if(timerInterval){clearInterval(timerInterval);timerInterval=null}
      overlayStart.style.display='flex';
      overlayStart.style.pointerEvents='auto';
      endModal.style.display='none';
      map.setView([54.5,-4],6);
    }

    function startGame(){
      clearMapObjects(true);
      cityTitle.style.display='none';
      overlayStart.style.display='none';
      started=true;
      startTime=Date.now();
      timerInterval=setInterval(()=>{timeEl.textContent=formatTime(Date.now()-startTime)},300);
      showNextCity();
    }

    function updateUI(){progressEl.textContent=`${index+1}/${TOTAL}`;scoreEl.textContent=score;}

    function showNextCity(){
      if(currentCityMarker){map.removeLayer(currentCityMarker); currentCityMarker=null;}
      clearMapObjects(false);
      answered=false;
      updateUI();
      if(index>=TOTAL){endGame();return;}
      cityTitle.textContent=cities[index].name;
      cityTitle.style.display='block';
      document.title=`Guess #${index+1}`;
    }

    map.on('click',function(e){
      if(!started||answered)return;
      answered=true;
      const clickCoords=[e.latlng.lat,e.latlng.lng];
      const city=cities[index];
      const m=L.marker(clickCoords).addTo(map);
      markers.push(m);
      const dist=haversine(clickCoords,city.coords);
      const c=L.circle(city.coords,{radius:10000,color:'#ff385c',fill:false}).addTo(map);
      circles.push(c);
      currentCityMarker=L.marker(city.coords).addTo(map);
      let points=0;
      let ok=false;
      if(dist<=10){ok=true;points=Math.max(0,Math.round(100-dist*10));}
      score+=points;
      results.push({city:city.name,dist:dist,points:points,ok:ok});
      // ÁßªÈô§Ââç‰∏ÄÂÄã popup
      map.closePopup();
      L.popup({maxWidth:280,closeButton:false,autoClose:true}).setLatLng(clickCoords).setContent(`<div style='font-weight:700'>${city.name}: ${dist.toFixed(1)} km ‚Äî ${ok?('Success +'+points+' pts'):'Fail (0)'}</div>`).openOn(map);
      index++;
      cityTitle.style.display='none';
      updateUI();
      setTimeout(()=>{showNextCity()},1000);
    });

    function clearMapObjects(removeAll=true){
      markers.forEach(m=>map.removeLayer(m));markers=[];
      circles.forEach(c=>map.removeLayer(c));circles=[];
      if(removeAll && currentCityMarker){map.removeLayer(currentCityMarker);currentCityMarker=null;}
      map.closePopup();
    }

    function endGame(){
      started=false;
      if(timerInterval){clearInterval(timerInterval);timerInterval=null;}
      const totalTime=Date.now()-startTime;
      const correct=results.filter(r=>r.ok).length;
      const distList=results.filter(r=>r.dist!==null).map(r=>r.dist);
      const avgDist=distList.length?(distList.reduce((s,v)=>s+v,0)/distList.length):0;
      const best=distList.length?Math.min(...distList):null;
      statsEl.innerHTML=`<div style='font-weight:700'>Score: ${score}</div><div>Correct: ${correct} / ${TOTAL}</div><div>Avg. distance: ${avgDist.toFixed(1)} km</div><div>Best: ${best===null?'-':best.toFixed(1)} km</div><div>Total time: ${formatTime(totalTime)}</div>`;
      endModal.style.display='flex';
    }

    startBtn.addEventListener('click',()=>{startGame()});
    playAgainBtn.addEventListener('click',()=>{resetGame()});

    resetGame();
  </script>
</body>
</html>