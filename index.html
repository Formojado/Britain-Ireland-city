<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK & Ireland City Speedrun - Survival Mode</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif;background:#0f1724;color:#e6eef8;overflow:hidden;}
    #map{height:100vh;width:100vw;position:relative;z-index: 1;}

    /* 初始畫面 */
    .overlay-start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15, 23, 42, 0.9);z-index:1000;}
    .start-box{background:#fff;color:#04263b;padding:30px;border-radius:16px;text-align:center;box-shadow:0 10px 50px rgba(0,0,0,0.5);max-width:400px;}
    .start-box h2{margin-top:0;color:#1e293b;}
    
    /* 頂部資訊欄 */
    .info-bar{position:absolute;top:15px;left:50%;transform:translateX(-50%);background:rgba(15, 23, 42, 0.85);padding:10px 20px;border-radius:12px;display:flex;gap:20px;z-index:900;color:#fff;backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.1);box-shadow:0 4px 15px rgba(0,0,0,0.3);}
    .info-item{display:flex;flex-direction:column;align-items:center;}
    .info-label{font-size:0.7rem;text-transform:uppercase;opacity:0.8;margin-bottom:2px;}
    .info-value{font-size:1.1rem;font-weight:700;}

    /* 當前目標城市 */
    .city-title{position:absolute;top:90px;left:50%;transform:translateX(-50%);z-index:1001;font-size:2.2rem;font-weight:800;color:#fff;text-shadow:0 0 10px rgba(0,0,0,0.8), 2px 2px 0px #3b82f6;pointer-events:none;text-align:center;width:100%;}

    /* 按鈕樣式 */
    .btn{background:#3b82f6;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;transition:all 0.2s;}
    .btn:hover{background:#2563eb;transform:translateY(-2px);}

    /* 結算彈窗 */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.85);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(8px);}
    .modal{background:#fff;color:#04263b;padding:30px;border-radius:20px;width:340px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.4);}
    .status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:800;margin-bottom:10px;}
    .status-fail{background:#fee2e2;color:#dc2626;}
    .status-pass{background:#dcfce7;color:#16a34a;}
    
    .out-indicator{color:#ef4444;font-weight:800;animation:blink 1s infinite;}
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="info-bar">
    <div class="info-item"><span class="info-label">Time</span><span id="time" class="info-value">00:00</span></div>
    <div class="info-item"><span class="info-label">Progress</span><span class="info-value"><span id="progress">0</span>/50</span></div>
    <div class="info-item"><span class="info-label">Score</span><span id="score" class="info-value">0</span></div>
    <div class="info-item" id="statusBox" style="display:none;"><span class="info-label">Status</span><span id="aliveStatus" class="info-value">ALIVE</span></div>
  </div>

  <div id="overlayStart" class="overlay-start">
    <div class="start-box">
      <h2>UK & Ireland Speedrun</h2>
      <p><b>規則：</b>誤差必須在 10km 內。<br>一旦失敗即視為「出局」，但你仍可繼續完成練習直到最後。</p>
      <button id="startBtn" class="btn">開始挑戰</button>
    </div>
  </div>

  <div class="city-title" id="cityTitle" style="display:none"></div>

  <div id="endModal" style="display:none" class="modal-backdrop">
    <div class="modal">
      <div id="badgeContainer"></div>
      <h3 id="resultTitle" style="margin:10px 0;">挑戰結束</h3>
      <div id="stats" style="line-height:1.6; margin-bottom:20px;"></div>
      <button id="playAgainBtn" class="btn">再試一次</button>
    </div>
  </div>

  <script>
    const ALL_CITIES = [
        {name:"London",coords:[51.5074,-0.1278]},{name:"Manchester",coords:[53.4808,-2.2426]},{name:"Birmingham",coords:[52.4862,-1.8904]},{name:"Glasgow",coords:[55.8642,-4.2518]},{name:"Liverpool",coords:[53.4084,-2.9916]},{name:"Edinburgh",coords:[55.9533,-3.1883]},{name:"Leeds",coords:[53.8008,-1.5491]},{name:"Sheffield",coords:[53.3811,-1.4701]},{name:"Bristol",coords:[51.4545,-2.5879]},{name:"Belfast",coords:[54.5973,-5.9301]},{name:"Dublin",coords:[53.3498,-6.2603]},{name:"Leicester",coords:[52.6369,-1.1398]},{name:"Coventry",coords:[52.4068,-1.5197]},{name:"Hull",coords:[53.7443,-0.3325]},{name:"Cardiff",coords:[51.4816,-3.1791]},{name:"Bradford",coords:[53.7938,-1.7564]},{name:"Newcastle",coords:[54.9783,-1.6178]},{name:"Nottingham",coords:[52.9548,-1.1581]},{name:"Southampton",coords:[50.9097,-1.4044]},{name:"Portsmouth",coords:[50.8198,-1.088]},{name:"Plymouth",coords:[50.3755,-4.1427]},{name:"Derby",coords:[52.9225,-1.4746]},{name:"Reading",coords:[51.4543,-0.9722]},{name:"Stoke-on-Trent",coords:[53.0027,-2.1794]},{name:"Wolverhampton",coords:[52.5862,-2.1288]},{name:"Swansea",coords:[51.6214,-3.9436]},{name:"Oxford",coords:[51.752,-1.2577]},{name:"Cambridge",coords:[52.2053,0.1218]},{name:"Norwich",coords:[52.6309,1.2974]},{name:"Aberdeen",coords:[57.1497,-2.0943]},{name:"Inverness",coords:[57.4778,-4.2247]},{name:"Cork",coords:[51.8985,-8.4756]},{name:"Limerick",coords:[52.6638,-8.6268]},{name:"Galway",coords:[53.2707,-9.0568]},{name:"Brighton",coords:[50.8225,-0.1372]},{name:"Exeter",coords:[50.726,-3.5275]},{name:"Gloucester",coords:[51.8642,-2.2467]},{name:"York",coords:[53.9591,-1.0812]},{name:"Blackpool",coords:[53.8175,-3.0357]},{name:"Dundee",coords:[56.462,-2.9707]},{name:"Londonderry",coords:[54.9966,-7.3074]},{name:"Milton Keynes",coords:[52.0406,-0.7594]},{name:"Northampton",coords:[52.2405,-0.9027]},{name:"Preston",coords:[53.7632,-2.7031]},{name:"Sunderland",coords:[54.9069,-1.3838]},{name:"Ipswich",coords:[52.0567,1.1482]},{name:"Bournemouth",coords:[50.7192,-1.8808]},{name:"Middlesbrough",coords:[54.5762,-1.2348]},{name:"Peterborough",coords:[52.5739,-0.2477]},{name:"Colchester",coords:[51.8917,0.903] }
    ];

    const TOTAL = 50;
    let cities=[], index=0, started=false, answered=false, markers=[], circles=[], score=0, startTime=null, timerInterval=null;
    let isGameOver = false; // 是否已出局
    let deathCity = "";     // 在哪裡陣亡
    let currentCityMarker = null;

    const map = L.map('map', {zoomControl:false}).setView([54.5, -4], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    const timeEl=document.getElementById('time');
    const progressEl=document.getElementById('progress');
    const scoreEl=document.getElementById('score');
    const aliveStatusEl=document.getElementById('aliveStatus');
    const cityTitle=document.getElementById('cityTitle');
    const endModal=document.getElementById('endModal');

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    function haversine(a,b){
      const R=6371;
      const dLat=(b[0]-a[0])*Math.PI/180;
      const dLon=(b[1]-a[1])*Math.PI/180;
      const aa=Math.sin(dLat/2)**2 + Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
    }

    function resetGame(){
      cities = shuffle([...ALL_CITIES]).slice(0, TOTAL);
      index=0; score=0; started=false; isGameOver=false; deathCity="";
      clearMapObjects();
      progressEl.textContent = "0";
      scoreEl.textContent = "0";
      timeEl.textContent = "00:00";
      aliveStatusEl.textContent = "ALIVE";
      aliveStatusEl.className = "info-value";
      document.getElementById('statusBox').style.display = 'none';
      if(timerInterval) clearInterval(timerInterval);
      document.getElementById('overlayStart').style.display = 'flex';
      endModal.style.display = 'none';
      cityTitle.style.display = 'none';
      map.setView([54.5, -4], 6);
    }

    function startGame(){
      document.getElementById('overlayStart').style.display = 'none';
      document.getElementById('statusBox').style.display = 'flex';
      started = true;
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const diff = Date.now() - startTime;
        timeEl.textContent = `${String(Math.floor(diff/60000)).padStart(2,'0')}:${String(Math.floor((diff%60000)/1000)).padStart(2,'0')}`;
      }, 1000);
      showNextCity();
    }

    function showNextCity(){
      if(index >= TOTAL){ endGame(); return; }
      answered = false;
      progressEl.textContent = index + 1;
      cityTitle.textContent = cities[index].name;
      cityTitle.style.display = 'block';
    }

    map.on('click', function(e){
      if(!started || answered) return;
      answered = true;
      
      const city = cities[index];
      const clickCoords = [e.latlng.lat, e.latlng.lng];
      const dist = haversine(clickCoords, city.coords);
      
      // 繪製點擊標記與正確位置
      markers.push(L.circleMarker(clickCoords, {radius:6, color:'#3b82f6'}).addTo(map));
      circles.push(L.circle(city.coords, {radius: 10000, color: '#10b981', weight: 2, fillOpacity: 0.1}).addTo(map));
      currentCityMarker = L.marker(city.coords).addTo(map)
        .bindPopup(`<b>${city.name}</b><br>${dist.toFixed(1)} km`)
        .openPopup();

      let isOk = dist <= 10;
      if(isOk) {
        score += Math.max(10, Math.round(100 - dist * 5));
      } else {
        if(!isGameOver) {
          isGameOver = true;
          deathCity = city.name;
          aliveStatusEl.textContent = "OUT";
          aliveStatusEl.classList.add("out-indicator");
        }
      }
      
      index++;
      setTimeout(() => {
        clearMapObjects();
        showNextCity();
      }, 1500);
    });

    function clearMapObjects(){
      markers.forEach(m => map.removeLayer(m)); markers = [];
      circles.forEach(c => map.removeLayer(c)); circles = [];
      if(currentCityMarker) { map.removeLayer(currentCityMarker); currentCityMarker = null; }
    }

    function endGame(){
      started = false;
      clearInterval(timerInterval);
      cityTitle.style.display = 'none';
      
      const badgeContainer = document.getElementById('badgeContainer');
      const resultTitle = document.getElementById('resultTitle');
      const stats = document.getElementById('stats');

      if(isGameOver) {
        badgeContainer.innerHTML = `<span class="status-badge status-fail">CHALLENGE FAILED</span>`;
        resultTitle.textContent = "遺憾出局！";
        stats.innerHTML = `你在 <b>${deathCity}</b> 附近陣亡了。<br>最終得分：${score}<br>總耗時：${timeEl.textContent}`;
      } else {
        badgeContainer.innerHTML = `<span class="status-badge status-pass">SURVIVED</span>`;
        resultTitle.textContent = "完美生存！";
        stats.innerHTML = `恭喜你完成了 50 城挑戰！<br>最終得分：${score}<br>總耗時：${timeEl.textContent}`;
      }
      
      endModal.style.display = 'flex';
    }

    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('playAgainBtn').addEventListener('click', resetGame);
    resetGame();
  </script>
</body>
</html>
