<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK & Ireland City Speedrun</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:'Segoe UI', Poppins, Arial, sans-serif;background:#0f1724;color:#e6eef8}
    #map{height:100vh;width:100vw;position:relative;z-index: 1;}

    .overlay-start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:1000;}
    .start-box{background:#fff;color:#04263b;padding:24px 36px;border-radius:12px;text-align:center;box-shadow:0 4px 30px rgba(0,0,0,0.5)}
    .start-box h2{margin-top:0;margin-bottom:8px}
    .btn{background:#60a5fa;color:#fff;border:none;padding:10px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition: 0.2s;}
    .btn:hover{background:#3b82f6;}

    .info-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(15, 23, 42, 0.8);padding:8px 14px;border-radius:8px;display:flex;gap:16px;z-index:900;color:#fff;font-size:0.95rem;border:1px solid rgba(255,255,255,0.1);}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:flex;align-items:center;justify-content:center;z-index:2000;}
    .modal{background:#fff;color:#04263b;padding:22px;border-radius:12px;min-width:320px;text-align:center;}
    .city-title{position:absolute;top:60px;left:50%;transform:translateX(-50%);z-index:1001;font-size:1.8rem;font-weight:700;color:#fff;text-shadow:2px 2px 8px #000; pointer-events: none;}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-bar">
    <div>â±ï¸ <span id="time">00:00</span></div>
    <div>ğŸ“ <span id="progress">0</span> / <span id="total">50</span></div>
    <div>â­ <span id="score">0</span></div>
  </div>

  <div id="overlayStart" class="overlay-start">
    <div class="start-box">
      <h2>UK & Ireland City Speedrun</h2>
      <p>åœ¨åœ°åœ–ä¸Šæ‰¾å‡º 50 å€‹åŸå¸‚<br>è·é›¢èª¤å·® 10km å…§ç®—æˆåŠŸï¼</p>
      <button id="startBtn" class="btn">é–‹å§‹æŒ‘æˆ°</button>
    </div>
  </div>

  <div class="city-title" id="cityTitle" style="display:none"></div>

  <div id="endModal" style="display:none" class="modal-backdrop">
    <div class="modal">
      <h3>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h3>
      <div id="stats"></div>
      <div style="margin-top:14px"><button id="playAgainBtn" class="btn">å†ç©ä¸€æ¬¡</button></div>
    </div>
  </div>

  <script>
    // è£œè¶³åŸå¸‚æ•¸æ“š (é€™éƒ¨åˆ†ä¹‹å‰æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è·‘ä¸å‹•)
    const ALL_CITIES = [
        {name:"London",coords:[51.5074,-0.1278]},{name:"Manchester",coords:[53.4808,-2.2426]},{name:"Birmingham",coords:[52.4862,-1.8904]},{name:"Glasgow",coords:[55.8642,-4.2518]},{name:"Liverpool",coords:[53.4084,-2.9916]},{name:"Edinburgh",coords:[55.9533,-3.1883]},{name:"Leeds",coords:[53.8008,-1.5491]},{name:"Sheffield",coords:[53.3811,-1.4701]},{name:"Bristol",coords:[51.4545,-2.5879]},{name:"Belfast",coords:[54.5973,-5.9301]},{name:"Dublin",coords:[53.3498,-6.2603]},{name:"Leicester",coords:[52.6369,-1.1398]},{name:"Coventry",coords:[52.4068,-1.5197]},{name:"Hull",coords:[53.7443,-0.3325]},{name:"Cardiff",coords:[51.4816,-3.1791]},{name:"Bradford",coords:[53.7938,-1.7564]},{name:"Newcastle",coords:[54.9783,-1.6178]},{name:"Nottingham",coords:[52.9548,-1.1581]},{name:"Southampton",coords:[50.9097,-1.4044]},{name:"Portsmouth",coords:[50.8198,-1.088]},{name:"Plymouth",coords:[50.3755,-4.1427]},{name:"Derby",coords:[52.9225,-1.4746]},{name:"Reading",coords:[51.4543,-0.9722]},{name:"Stoke-on-Trent",coords:[53.0027,-2.1794]},{name:"Wolverhampton",coords:[52.5862,-2.1288]},{name:"Swansea",coords:[51.6214,-3.9436]},{name:"Oxford",coords:[51.752,-1.2577]},{name:"Cambridge",coords:[52.2053,0.1218]},{name:"Norwich",coords:[52.6309,1.2974]},{name:"Aberdeen",coords:[57.1497,-2.0943]},{name:"Inverness",coords:[57.4778,-4.2247]},{name:"Cork",coords:[51.8985,-8.4756]},{name:"Limerick",coords:[52.6638,-8.6268]},{name:"Galway",coords:[53.2707,-9.0568]},{name:"Brighton",coords:[50.8225,-0.1372]},{name:"Exeter",coords:[50.726,-3.5275]},{name:"Gloucester",coords:[51.8642,-2.2467]},{name:"York",coords:[53.9591,-1.0812]},{name:"Blackpool",coords:[53.8175,-3.0357]},{name:"Dundee",coords:[56.462,-2.9707]},{name:"Londonderry",coords:[54.9966,-7.3074]},{name:"Milton Keynes",coords:[52.0406,-0.7594]},{name:"Northampton",coords:[52.2405,-0.9027]},{name:"Preston",coords:[53.7632,-2.7031]},{name:"Sunderland",coords:[54.9069,-1.3838]},{name:"Ipswich",coords:[52.0567,1.1482]},{name:"Bournemouth",coords:[50.7192,-1.8808]},{name:"Middlesbrough",coords:[54.5762,-1.2348]},{name:"Peterborough",coords:[52.5739,-0.2477]},{name:"Colchester",coords:[51.8917,0.903] }
    ];

    const TOTAL = 50;
    let cities=[], index=0, started=false, answered=false, markers=[], circles=[], score=0, startTime=null, timerInterval=null, results=[], currentCityMarker=null;

    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', {zoomControl:true}).setView([54.5, -4], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const timeEl=document.getElementById('time');
    const progressEl=document.getElementById('progress');
    const totalEl=document.getElementById('total');
    const scoreEl=document.getElementById('score');
    const overlayStart=document.getElementById('overlayStart');
    const cityTitle=document.getElementById('cityTitle');
    const endModal=document.getElementById('endModal');
    const statsEl=document.getElementById('stats');

    totalEl.textContent = TOTAL;

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    function toRad(v){return v*Math.PI/180}
    function haversine(a,b){
      const R=6371;
      const dLat=toRad(b[0]-a[0]);
      const dLon=toRad(b[1]-a[1]);
      const aa=Math.sin(dLat/2)**2 + Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));
    }
    function formatTime(ms){
      const s=Math.floor(ms/1000);
      return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }

    function resetGame(){
      cities = shuffle([...ALL_CITIES]).slice(0, TOTAL);
      index = 0; score = 0; started = false; results = [];
      clearMapObjects(true);
      updateUI();
      timeEl.textContent = '00:00';
      if(timerInterval) clearInterval(timerInterval);
      overlayStart.style.display = 'flex';
      endModal.style.display = 'none';
      cityTitle.style.display = 'none';
      map.setView([54.5, -4], 6);
    }

    function startGame(){
      overlayStart.style.display = 'none';
      started = true;
      startTime = Date.now();
      timerInterval = setInterval(() => { timeEl.textContent = formatTime(Date.now() - startTime) }, 1000);
      showNextCity();
    }

    function updateUI(){
      progressEl.textContent = index;
      scoreEl.textContent = score;
    }

    function showNextCity(){
      if(index >= TOTAL){ endGame(); return; }
      answered = false;
      cityTitle.textContent = `æ‰¾æ‰¾çœ‹: ${cities[index].name}`;
      cityTitle.style.display = 'block';
    }

    map.on('click', function(e){
      if(!started || answered) return;
      answered = true;
      
      const city = cities[index];
      const clickCoords = [e.latlng.lat, e.latlng.lng];
      const dist = haversine(clickCoords, city.coords);
      
      // é¡¯ç¤ºç©å®¶é»çš„åœ°æ–¹
      markers.push(L.marker(clickCoords).addTo(map));
      
      // é¡¯ç¤ºæ­£ç¢ºä½ç½® (ç´…è‰²åœˆåœˆèˆ‡æ¨™è¨˜)
      const correctCircle = L.circle(city.coords, {radius: 10000, color: '#ff385c', fillOpacity: 0.2}).addTo(map);
      circles.push(correctCircle);
      currentCityMarker = L.marker(city.coords, {opacity: 0.8}).addTo(map).bindPopup(`<b>${city.name}</b>`).openPopup();

      let points = 0;
      let isOk = dist <= 10;
      if(isOk) points = Math.max(10, Math.round(100 - dist * 5));
      
      score += points;
      results.push({dist, points, ok: isOk});
      
      index++;
      updateUI();

      setTimeout(() => {
        clearMapObjects(false);
        showNextCity();
      }, 1500);
    });

    function clearMapObjects(all){
      markers.forEach(m => map.removeLayer(m)); markers = [];
      circles.forEach(c => map.removeLayer(c)); circles = [];
      if(currentCityMarker) { map.removeLayer(currentCityMarker); currentCityMarker = null; }
    }

    function endGame(){
      started = false;
      clearInterval(timerInterval);
      const correct = results.filter(r => r.ok).length;
      statsEl.innerHTML = `
        <p>ç¸½åˆ†ï¼š<b>${score}</b></p>
        <p>å‘½ä¸­æ¬¡æ•¸ï¼š${correct} / ${TOTAL}</p>
        <p>ç¸½è€—æ™‚ï¼š${timeEl.textContent}</p>
      `;
      endModal.style.display = 'flex';
      cityTitle.style.display = 'none';
    }

    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('playAgainBtn').addEventListener('click', resetGame);
    
    resetGame();
  </script>
</body>
</html>
